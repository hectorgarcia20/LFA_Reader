<!-- ⚠️ Esto es tu archivo completo actualizado -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LFA Reader</title>
  <style>
    /* ... (todo el estilo queda igual, no lo repito por espacio) ... */
  </style>
</head>
<body>
  <div class="main-container">
    <div class="title">LFA Reader</div>
    <button onclick="connectBluetooth()">Bluetooth</button>
    <button onclick="downloadLog()">Descargar Bloc de Notas</button>
    <button onclick="downloadFirebaseLog()">Descargar Global (Firebase)</button>

    <div class="detected-color-container">
      <div style="font-weight: bold; font-size: 20px;">DETECTED COLOR</div>
      <div id="detected-color" style="font-size: 22px;">"INDEFINIDO"</div>
    </div>
    <div id="intensity-container">INTENSIDAD: 0</div>
    <div id="lux">LUX: 0</div>
    <div class="data-boxes">
      <div class="box">
        <div class="box-circle red"></div>
        <p>RED</p>
        <p id="Red">0</p>
        <hr class="red-line">
      </div>
      <div class="box">
        <div class="box-circle green"></div>
        <p>GREEN</p>
        <p id="Green">0</p>
        <hr class="green-line">
      </div>
      <div class="box">
        <div class="box-circle blue"></div>
        <p>BLUE</p>
        <p id="Blue">0</p>
        <hr class="blue-line">
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDb0MNZx7DZM_u9fz9VYad5EptkVdnK2YQ",
      authDomain: "lfar-cb399.firebaseapp.com",
      databaseURL: "https://lfar-cb399-default-rtdb.firebaseio.com",
      projectId: "lfar-cb399",
      storageBucket: "lfar-cb399.appspot.com",
      messagingSenderId: "140652099318",
      appId: "1:140652099318:web:c1f4342562b05398e51ed7",
      measurementId: "G-77T2SHFNPG"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let useBluetooth = false;
    let logData = [];
    let connectedDeviceName = null; // ✅ NUEVO

    function updateValue(refName, elementId, prefix = "") {
      if (useBluetooth) return;
      const dataRef = database.ref(`LFAR/${refName}`);
      dataRef.on('value', function(snapshot) {
        const value = snapshot.val();
        document.getElementById(elementId).innerHTML = prefix + value;
      });
    }

    updateValue("Rojo", "Red");
    updateValue("Azul", "Blue");
    updateValue("Verde", "Green");
    updateValue("Color_detectado", "detected-color", "\"");
    updateValue("Lux", "lux", "LUX: ");
    updateValue("Intensidad", "intensity-container", "INTENSIDAD: ");

    const serviceUuid = "12345678-1234-1234-1234-1234567890ab";
    const characteristicUuid = "abcd1234-5678-90ab-cdef-1234567890ab";

    async function connectBluetooth() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: "LFA Sensor" }],
          optionalServices: [serviceUuid]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUuid);
        const characteristic = await service.getCharacteristic(characteristicUuid);

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueChanged);

        console.log("✅ Conectado a", device.name);
        useBluetooth = true;
        connectedDeviceName = device.name || "Desconocido"; // ✅ NUEVO
        firebase.database().ref("LFAR").off();

      } catch (error) {
        console.error("❌ Error al conectar vía Bluetooth:", error);
      }
    }

    function handleCharacteristicValueChanged(event) {
      const value = new TextDecoder().decode(event.target.value);
      const data = {};
      value.split(',').forEach(pair => {
        const [key, val] = pair.split(':');
        data[key.trim()] = val.trim();
      });

      const color = data["Color"];
      const timestamp = new Date().toLocaleString();
      const logLine = `[${timestamp}] R:${data["R"]}, G:${data["G"]}, B:${data["B"]}, Lux:${data["Lux"]}, Color:${color}`;
      logData.push(logLine);

      // ✅ Guardar en Firebase bajo el nombre del dispositivo
      const devicePath = connectedDeviceName || "Desconocido";
      firebase.database().ref("Lecturas/" + devicePath).push({
        timestamp: timestamp,
        R: data["R"],
        G: data["G"],
        B: data["B"],
        Lux: data["Lux"],
        Color: color
      });

      document.getElementById("Red").innerText = data["R"];
      document.getElementById("Green").innerText = data["G"];
      document.getElementById("Blue").innerText = data["B"];
      document.getElementById("lux").innerText = "LUX: " + data["Lux"];
      document.getElementById("intensity-container").innerText = "INTENSIDAD: " + data["Lux"];
      document.getElementById("detected-color").innerText = `"${color.toUpperCase()}"`;

      const intensityContainer = document.getElementById('intensity-container');
      const luxElement = document.getElementById('lux');
      const detectedColorText = document.getElementById('detected-color');
      const detectedColorContainer = document.querySelector('.detected-color-container');

      if (color === 'Rojo') {
        intensityContainer.style.backgroundColor = 'var(--red)';
        luxElement.style.color = 'var(--red)';
        detectedColorText.style.color = 'var(--red)';
        detectedColorContainer.style.color = 'var(--red)';
      } else if (color === 'Azul') {
        intensityContainer.style.backgroundColor = 'var(--blue)';
        luxElement.style.color = 'var(--blue)';
        detectedColorText.style.color = 'var(--blue)';
        detectedColorContainer.style.color = 'var(--blue)';
      } else if (color === 'Verde') {
        intensityContainer.style.backgroundColor = 'var(--green)';
        luxElement.style.color = 'var(--green)';
        detectedColorText.style.color = 'var(--green)';
        detectedColorContainer.style.color = 'var(--green)';
      } else {
        intensityContainer.style.backgroundColor = '#555';
        luxElement.style.color = '#555';
        detectedColorText.style.color = '#555';
        detectedColorContainer.style.color = '#555';
      }
    }

    function downloadLog() {
      if (logData.length === 0) {
        alert("No hay datos para guardar.");
        return;
      }

      const blob = new Blob([logData.join("\n")], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = "lecturas_lfa.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function downloadFirebaseLog() {
      if (!connectedDeviceName) {
        alert("Primero conecta un dispositivo Bluetooth.");
        return;
      }

      const devicePath = connectedDeviceName;
      const ref = firebase.database().ref("Lecturas/" + devicePath);
      ref.once('value', function(snapshot) {
        const entries = snapshot.val();
        if (!entries) {
          alert("No hay datos guardados en Firebase para este dispositivo.");
          return;
        }

        const lines = Object.values(entries).map(entry => {
          return `[${entry.timestamp}] R:${entry.R}, G:${entry.G}, B:${entry.B}, Lux:${entry.Lux}, Color:${entry.Color}`;
        });

        const blob = new Blob([lines.join("\n")], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `lecturas_${devicePath}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }
  </script>
</body>
</html>
